
# Подготовительные действия
1. **Подготовьте к работе свою учетную запись VPN** 

      - **Для Shadowsocks**

           1. Приобретите на стороне учетную запись **Shadowsocks** клиента, либо установите **[свой сервер на docker](https://github.com/shadowsocks/shadowsocks-libev/blob/master/docker/alpine/README.md)** (дело 5-ти минут).  
           2. Получите и приготовьте четыре параметра Вашего **Shadowsocks** сервера:
               - **IP адрес** или доменное имя сервера
               - **Номер** удаленного порта
               - **Пароль** для доступа
               - **Метод шифрования** на стороне сервера

      - Для других **VPN** соединений: **OpenVPN**, **Wireguard**, **IKE**, **PPPOE**, **L2TP**, **SSTP** - **[настройте подключение на своем роутере](https://help.keenetic.com/hc/ru/search?utf8=✓&query=Подключение+по+протоколу&commit=Поиск)** и проверьте его работоспособность. 
3. Установите **[Entware](https://help.keenetic.com/hc/ru/articles/360000948719-OPKG)**
4. Этот шаг пропускаем, если у Вас установлена версия прошивки **начиная с версии 3.9.Х**. В случае же, если у Вас прошивка устройства **до версии 3.8.Х**, установите следующие необходимые компоненты в **WUI** роутера через меню 
**Общие настройки -> [Изменить набор компонентов](https://help.keenetic.com/hc/ru/articles/360009294539-Описание-компонентов-KeeneticOS)**:
    - **Модули ядра подсистемы Netfilter**
    - **Пакет расширения Xtables-addons для Netfilter**

   ![Снимок экрана 2022-12-17 в 12 52 55](https://user-images.githubusercontent.com/105032261/208236223-6c099545-336f-4cd5-8785-5c9bcf02aadf.png)



5. Cкачайте требуемую версию пакета на роутер, например в папку **/opt/packages/**, предварительно ее создав. Крайнюю версию пакета всегда можно найти по [этой ссылке](https://github.com/qzeleza/kvas/releases/latest).

6. Зайдите в админ панель роутера по адресу: **https://<IP роутера>/a** (будьте бдительны - символ **‘а’** в конце адреса не описка) и введите в поле **Command** следующую команду `opkg dns-override`, затем нажмите кнопку **Send request**.
   ![Снимок экрана 2022-12-17 в 12 37 52](https://user-images.githubusercontent.com/105032261/208235733-24d62843-8102-4905-bd16-69d461259862.png)
   ![Снимок экрана 2022-12-17 в 12 32 13](https://user-images.githubusercontent.com/105032261/208235772-278844ef-91be-4eda-af34-ce7f536c00f0.png)



7. Далее, необходимо сохранить настройки, в том же поле введите команду ```system configuration save```, затем нажмите кнопку **Send request**. 


8. И затем, **необходимо перегрузить роутер**, для этого, в том же поле введите ```system reboot```, после чего, нажмите **Send request**.

## ВНИМАНИЕ!
> После ввода команды `opkg dns-override` у Вас должен пропасть интернет. Это нормально. Так и должно быть.
> Все последующие шаги по установке пакета позволят его реанимировать.

## ВАЖНО!

>  ПЕРЕД ПОДКЛЮЧЕНИЕМ КЛИЕНТОВ К РОУТЕРУ ОБЯЗАТЕЛЬНО ПРОВЕРЬТЕ:
>  
>  1. ЧТО **В НАСТРОЙКАХ ВАШИХ КЛИЕНТОВ**, КОТОРЫЕ ПОДКЛЮЧАЮТСЯ К НЕМУ ПО WIFI ИЛИ ПО VPN, 
>     В СТРОКЕ АДРЕСА ВАШЕГО DNS, УКАЗАН АДРЕС ВАШЕГО РОУТЕРА, А НЕ DNS ВАШЕГО ПРОВАЙДЕРА 
>     ИЛИ ИЗ СПИСКА СТАНДАРТНЫХ АДРЕСОВ ТИПА 8.8.8.8, 1.1.1.1, 9.9.9.9 ИЛИ ИМ ПОДОБНЫЕ. 
>  
>  2. ЧТО **ВАШ БРАУЗЕР НЕ ИСПОЛЬЗУЕТ СОБСТВЕННЫЕ DNS**, ТАК КАК ОНИ ИМЕЮТ БОЛЬШИЙ ПРИОРИТЕТ, 
>     ЧЕМ НАСТРОЙКИ, УКАЗАННЫЕ В ПУНКТЕ ВЫШЕ.
>    
>  3. ПРОВЕРЬТЕ В ЛИЧНОМ КАБИНЕТЕ ПРОВАЙДЕРА, ЧТО **ОТКЛЮЧЕНА ПОДДЕРЖКА IPV6**, ЕСЛИ ТАКОВОЙ ПУНКТ ИМЕЕТСЯ. 



# Установка пакета на устройство
#### После обязательной перезагрузки устройства:
1. Если у Вас уже была установлена какая либо версия пакета, то 
    - создайте, по необходимости, архивную копию **Белого списка** командой `kvas export ./hosts.backup`
    - удалите предыдущую версию пакета (если она была установлена ранее) командой `kvas remove full` (на версиях, начиная с 1.0-beta-22).
2. Установите новую версию при помощи команды `opkg install <пакет>`.

   ![Снимок экрана 2022-12-17 в 12 44 43](https://user-images.githubusercontent.com/105032261/208235988-635a091b-a471-4c5e-b2bb-bd9071f587f0.png)


3. Настройте пакет при помощи команды `kvas setup`. В случае, если в процессе установки, Вы выбрали **shadowsocks** соединение, то введите, полученные Вами данные на [подготовительном шаге](#подготовительные-действия). 
4. Далее, отвечайте на вопросы по ходу установки (один из вариантов установки пакета ниже на рисунке).

   ![Снимок экрана 2022-12-17 в 12 45 09](https://user-images.githubusercontent.com/105032261/208236370-2a66b6aa-26bb-4986-8357-b7148b54c0c9.png)


5. Если Вы ранее, на первом шаге, делали архивную копию своего Белого списка, то восстанавливаем его по необходимости командой `kvas import ./hosts.backup`
6. Для проверки работоспособности, можете запустить проверку пакета командой `kvas test`


## Пример кода установки:
 
### Стадия подготовки
```
mkdir -p /opt/packages # только в случае отсутствия папки
cd /opt/packages
wget https://github.com/qzeleza/kvas/tree/main/ipk/kvas_Х.Х-ХХ_all.ipk # вместо Х.Х-ХХ подставляете желаемую версию пакета
```
### Стадия установки
```sh    
kvas export ./hosts.backup # если ранее был установлен Квас на устройства 
opkg remove kvas # или 
kvas remove full # если ранее установленная версия Кваса была, начиная от 1.0-beta-22
opkg install /opt/packages/kvas_Х.Х-ХХ_all.ipk # вместо Х.Х-ХХ подставляете желаемую версию пакета
kvas setup
kvas import ./hosts.backup # если ранее сохраняли Белый список в файл ./hosts.backup. 
kvas test # далее, можете запустить проверку работоспособности пакета. 
```
---



# Удаление пакета
1. До версии **Квас 1.0-beta-22**
    - Выполняем команду `opkg remove kvas`
    - Полное удаление пакета (вместе с зависимыми пакетами) осуществляется командой `opkg remove kvas --autoremove`

1. Начиная с версии **Квас 1.0-beta-22**
   - Частичное (сохраняя архивные копии) удаление пакета осуществляется командой `kvas remove`
   - Полное удаление пакета (вместе с зависимыми пакетами) осуществляется командой `kvas remove full`

   ![Снимок экрана 2022-12-17 в 12 40 54](https://user-images.githubusercontent.com/105032261/208236387-5e5bb99a-4f10-4beb-9e5a-588e7116c70f.png)


***Пример кода ПОЛНОГО удаления пакета:*** 
```sh
opkg remove kvas --autoremove # для ранних версий
kvas remove full. # или для поздних версий
```

# Диагностика в случае проблем
Существует два уровня диагностики:

1. Для проверки работы пакета наберите ```kvas test```
2. В случае отсутствия результата, наберите ```kvas debug > ./kvas.debug``` и отправьте сообщение автору через [форум Keenetic](https://forum.keenetic.com/profile/20603-zeleza/) или через его почту `kvas собачка zeleza.ru` сформированный **файл**.



# Использование AdGuard Home с пакетом Квас

## ВАЖНО!
> Квас не поддерживает **AdGuard Home** в случае, если **AdGuard Home** был установлен не через **entware**, командой `opkg Install`, в ручную, путем копирования исполняемого файла c **GitHub**.

### Последовательность шагов до версии **Квас 1.0-beta-21**:
1. Устанавливаем и запускаем **AdGuardHome** (см. примечание ниже с пометкой **ВАЖНО!**): 
   - Устанавливаем **AdGuardHome** на роутер: `opkg install adguardhome-go`
   - Производим первый запуск **AdGuardHome** командой `AdGuardHome` и следуем инструкциям на экране.
2. [Осуществляем первичную настройку AdGuard Home](https://adguard.com/ru/blog/adguard-home-on-public-server.html)
3. [Устанавливаем Квас](https://github.com/qzeleza/kvas/wiki/Установка-пакета/_edit#установка-пакета-на-устройство)
4. Подключаем **AdGuardHome** к **Квасу** командой `kvas adguard on`
5. Обновляем версию **AdGuardHome** на крайнюю, командой `kvas adguard update`

### Последовательность шагов, начиная с версии **Квас 1.0-beta-22**:
1. После [установки Квас на устройство](#установка-пакета-на-устройство), устанавливаем **AdGuard Home** командой `kvas adguard on` и следуем инструкциям на экране.
   - После запроса, переходим в клиентский браузер по указанному **IP и номеру порта** и [осуществляем первичную настройку **AdGuardHome**](https://adguard.com/ru/blog/adguard-home-on-public-server.html).
   - Далее, вновь переходим в терминал устройства и наживаем там **Ctrl-C**.
2. Произойдет обновление и настройка **AdGuardHome** до крайней актуальной версии, после чего Вы можете проверить совместную работу Квас и **AdGuardHome** командой `kvas test` 


## ВАЖНО! 
> Пакет **AdGuard Home** должен быть установлен исключительно на роутер на котором установлен пакет **Квас**.
> Работа пакета **AdGuard Home** в связке с пакетом **Квас**, когда оба пакета находятся на различных устройствах **НЕ ПРЕДСТАВЛЯЕТСЯ ВОЗМОЖНОЙ**!

# Примеры использования
```sh
kvas setup         - запускаем первоначальную настройку пакета
kvas add ya.ru     - добавляем ya.ru в список разблокировки без поддержки регулярных выражений.
kvas add *ya.ru    - добавляем ya.ru в список разблокировки c поддержкой регулярных выражений.
kvas import ./list - добавляем хосты из файла в списочный файл.
kvas rm google     - удаляем все хосты со словом google внутри, из списка разблокировки.
kvas show          - выводим все хосты из списка разблокировки.
kvas test          - тестируем работу всех служб пакета.
kvas debug > ./log - сохраняем журнал отладочной информации в файл.
kvas purge         - удаляем все доменные имена из списка разблокировки.
kvas remove full   - производим ПОЛНОЕ удаление пакета со всеми архивными копиями.
```

## НАВИГАЦИЯ
- [**<<--** Описание пакета](https://github.com/qzeleza/kvas/wiki/Home) 
- [Описание команд **-->>**](https://github.com/qzeleza/kvas/wiki/Описание-команд)