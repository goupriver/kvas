## Подготовительные действия

**Подготовьте к работе свою учетную запись VPN** 

1. **Для Shadowsocks**

      1. Приобретите на стороне учетную запись **Shadowsocks** клиента, либо установите **[свой сервер на docker](https://github.com/shadowsocks/shadowsocks-libev/blob/master/docker/alpine/README.md)** (дело 5-ти минут).
         
         **Внимание!** Практика показывает, что аренду сервера необходимо осуществлять у зарубежного провайдера! Это поможет решить проблемы с частичным открытием доменов из "белого списка".
   
   3. Получите и приготовьте четыре параметра:
         - **IP адрес** или доменное имя **Shadowsocks** сервера
         - **Номер** удаленного **порта Shadowsocks** сервера
         - **Пароль** для доступа на **Shadowsocks** сервер
         - **Метод шифрования** на стороне **Shadowsocks** сервера

---
2. Для других **VPN** соединений: **OpenVPN**, **Wireguard**, **IKE**, **PPPOE**, **L2TP**, **SSTP** - **[настройте подключение на своем роутере](https://help.keenetic.com/hc/ru/search?utf8=✓&query=Подключение+по+протоколу&commit=Поиск)** и проверьте его работоспособность. 
3. Установите **[Entware](https://help.keenetic.com/hc/ru/articles/360000948719-OPKG)**
4. Установите необходимые компоненты в **WUI** роутера: **Общие настройки -> [Изменить набор компонентов](https://help.keenetic.com/hc/ru/articles/360009294539-Описание-компонентов-KeeneticOS):**
    - **Модули ядра подсистемы Netfilter**
    - **Пакет расширения Xtables-addons для Netfilter**
5. Зайдите в админ панель роутера по адресу: **https://<IP роутера>/a** (будьте бдительны - символ **‘а’** в конце адреса не описка) и введите в поле **Command** следующую команду ```opkg dns-override```, затем нажмите кнопку **Send request**. 
6. Далее, необходимо сохранить настройки, в том же поле введите команду ```system configuration save```, затем нажмите кнопку **Send request**. 
7. И затем, необходимо перегрузить роутер, для этого, в том же поле введите ```system reboot```, после чего, нажмите **Send request**.

---

## Установка пакета на устройство
После перезагрузки устройства:
1. Cкачайте требуемую версию пакета на роутер, например в папку **/opt/packages/**. Крайнюю версию пакета всегда можно найти по [этой ссылке](https://github.com/qzeleza/kvas/tree/main/ipk).
2. Удалите предыдущую версию пакета (если она была установлена ранее)
3. Установите новую версию при помощи команды `opkg install <пакет>`.
4. Настройте пакет при помощи команды `kvas setup`. В процессе установки введите, полученные Вами данные на [подготовительном шаге](#подготовительные-действия) (учетные данные **shadowsocks**). 
5. Далее, отвечайте на вопросы по ходу установки.
6. После окончания настройки пакета, можете запустить проверку работоспособностью командой `kvas test`

```
 ВАЖНО!
 
 ПЕРЕД ПОДКЛЮЧЕНИИ КЛИЕНТОВ К РОУТЕРУ ОБЯЗАТЕЛЬНО ПРОВЕРЬТЕ:
 
 1. ЧТО В НАСТРОЙКАХ ВАШИХ КЛИЕНТОВ, КОТОРЫЕ ПОДКЛЮЧАЮТСЯ К НЕМУ ПО WIFI ИЛИ ПО VPN, 
    В СТРОКЕ АДРЕСА ВАШЕГО DNS, УКАЗАН АДРЕС ВАШЕГО РОУТЕРА, А НЕ DNS ВАШЕГО ПРОВАЙДЕРА 
    ИЛИ ИЗ СПИСКА СТАНДАРТНЫХ АДРЕСОВ ТИПА 8.8.8.8, 1.1.1.1, 9.9.9.9 ИЛИ ИМ ПОДОБНЫЕ. 
 
 2. ЧТО ВАШ БРАУЗЕР НЕ ИСПОЛЬЗУЕТ СОБСТВЕННЫЕ DNS, ТАК КАК ОНИ ИМЕЮТ БОЛЬШИЙ ПРИОРИТЕТ, 
    ЧЕМ НАСТРОЙКИ, УКАЗАННЫЕ В ПУНКТЕ ВЫШЕ.
   
 3. ПРОВЕРЬТЕ В ЛИЧНОМ КАБИНЕТЕ ПРОВАЙДЕРА, ЧТО ОТКЛЮЧЕНА ПОДДЕРЖКА IPV6, ЕСЛИ ТАКОВОЙ ПУНКТ ИМЕЕТСЯ. 
 
```

***Пример кода установки:*** 
```
    mkdir -p /opt/packages # только в случае отсутствия папки
    cd /opt/packages
    opkg remove kvas
    wget https://github.com/qzeleza/kvas/tree/main/ipk/kvas_Х.Х-ХХ_all.ipk
    opkg install /opt/packages/kvas_Х.Х-ХХ_all.ipk
    kvas setup
    # Вместо Х.Х-ХХ подставляете актуальную версию пакета
    # далее, можете запустить проверку работоспособности пакета. 
    kvas test
```

### ВНИМАНИЕ!
Если ранее пакет был уже установлен, то при запросе об удалении файлов конфигурации можете их не удалять, тогда не придется повторно вводить данные установки соединения.

## Удаление пакета
1. Частичное (сохраняя архивные копии) удаление пакета осуществляется командой `kvas remove`
2. Полное удаление пакета осуществляется командой `kvas remove full`

***Пример кода ПОЛНОГО удаления пакета:*** 
```
kvas remove full
```

## Диагностика в случае проблем
Существует два уровня диагностики:

1. Для проверки работы пакета наберите ```kvas test```
2. В случае отсутствия результата, наберите ```kvas debug > ./kvas.debug``` и отправьте сообщение автору через [форум Keenetic](https://forum.keenetic.com/profile/20603-zeleza/) или через его почту `kvas собачка zeleza.ru` сформированный **файл**.


## Использование AdGuard Home с пакетом Квас

### Последовательность шагов:
1. Устанавливаем и запускаем **AdGuardHome** (см. примечание ниже с пометкой **ВАЖНО!**): 
   - Устанавливаем **AdGuardHome** на роутер: `opkg install adguardhome-go`
   - Производим первый запуск **AdGuardHome** командой `AdGuardHome` и следуем инструкциям на экране.
2. [Осуществляем первичную настройку AdGuard Home](https://adguard.com/ru/blog/adguard-home-on-public-server.html)
3. [Устанавливаем Квас](#установка-пакета)
4. Подключаем **AdGuardHome** к **Квасу** командой `kvas adguard on`
5. Обновляем версию **AdGuardHome** на крайнюю, командой `kvas adguard update`

```
ВАЖНО! 

Начиная с версии Квас 1.0-beta-22, AdGuardHome можно локально уставновить командой `kvas adguard on`. Квас, самостоятельно 
позаботится об установке AdGuardHome (если его не было на роутере) и его обновлении. Вам необходимо будет только 
провести первоначальную настройку AdGuardHome после соотвествующего сообщения в консоли, перейдя в свой браузер по 
указанному IP и номеру порта, после настройки Вы должны будете вернуться опять в консоль роутера и нажать Ctrl-C.

При этом сам пакет AdGuardHome должен быть установлен исключительно на роутер на котором установлен пакет Квас.
Работа пакета AdGuardHome в связке с пакетом Квас, когда оба пакета находятся на различных устройствах - ПОКА НЕ ПРЕДСТАВЛЯЕТСЯ ВОЗМОЖНОЙ!
```

## Примеры использования
```
kvas setup         - запускаем первоначальную настройку пакета
kvas add ya.ru     - добавляем ya.ru в список разблокировки без поддержки регулярных выражений.
kvas add *ya.ru    - добавляем ya.ru в список разблокировки c поддержкой регулярных выражений.
kvas import ./list - добавляем хосты из файла в списочный файл.
kvas rm google     - удаляем все хосты со словом google внутри, из списка разблокировки.
kvas show          - выводим все хосты из списка разблокировки.
kvas test          - тестируем работу всех служб пакета.
kvas debug > ./log - сохраняем журнал отладочной информации в файл.
kvas purge         - удаляем все доменные имена из списка разблокировки.
kvas remove full   - производим ПОЛНОЕ удаление пакета со всеми архивными копиями.
```

