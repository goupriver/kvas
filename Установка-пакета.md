
# Подготовительные действия
1. **Подготовьте к работе свою учетную запись VPN** 

      - **Для Shadowsocks**

           1. Приобретите на стороне учетную запись **Shadowsocks** клиента, либо установите **[свой сервер на docker](https://github.com/shadowsocks/shadowsocks-libev/blob/master/docker/alpine/README.md)** (дело 5-ти минут).  
           2. Получите и приготовьте четыре параметра Вашего **Shadowsocks** сервера:
               - **IP адрес** или доменное имя сервера
               - **Номер** удаленного порта
               - **Пароль** для доступа
               - **Метод шифрования** на стороне сервера

      - Для других **VPN** соединений: **OpenVPN**, **Wireguard**, **IKE**, **PPPOE**, **L2TP**, **SSTP** - **[настройте подключение на своем роутере](https://help.keenetic.com/hc/ru/search?utf8=✓&query=Подключение+по+протоколу&commit=Поиск)** и проверьте его работоспособность. 
3. Установите **[Entware](https://help.keenetic.com/hc/ru/articles/360000948719-OPKG)**
4. Этот шаг пропускаем, если у Вас установлена версия прошивки **начиная с версии 3.9.Х**. В случае же, если у Вас прошивка устройства **до версии 3.8.Х**, установите следующие необходимые компоненты в **WUI** роутера через меню 
**Общие настройки -> [Изменить набор компонентов](https://help.keenetic.com/hc/ru/articles/360009294539-Описание-компонентов-KeeneticOS)**:
    - **Модули ядра подсистемы Netfilter**
    - **Пакет расширения Xtables-addons для Netfilter**

   ![Снимок экрана 2022-12-17 в 12 52 55](https://user-images.githubusercontent.com/105032261/208236223-6c099545-336f-4cd5-8785-5c9bcf02aadf.png)


6. Зайдите в админ панель роутера по адресу: **https://<IP роутера>/a** (будьте бдительны - символ **‘а’** в конце адреса не описка) и введите в поле **Command** следующую команду `opkg dns-override`, затем нажмите кнопку **Send request**.
   ![Снимок экрана 2022-12-17 в 12 37 52](https://user-images.githubusercontent.com/105032261/208235733-24d62843-8102-4905-bd16-69d461259862.png)
   ![Снимок экрана 2022-12-17 в 12 32 13](https://user-images.githubusercontent.com/105032261/208235772-278844ef-91be-4eda-af34-ce7f536c00f0.png)



7. Далее, необходимо сохранить настройки, в том же поле введите команду ```system configuration save```, затем нажмите кнопку **Send request**. 


8. И затем, **необходимо перегрузить роутер**, для этого, в том же поле введите ```system reboot```, после чего, нажмите **Send request**.

## ВНИМАНИЕ!
> После ввода команды `opkg dns-override` у Вас должен пропасть интернет. Это нормально. Так и должно быть.
> Все последующие шаги по установке пакета позволят его реанимировать.

## ВАЖНО!

>  ПЕРЕД ПОДКЛЮЧЕНИЕМ КЛИЕНТОВ К РОУТЕРУ ОБЯЗАТЕЛЬНО ПРОВЕРЬТЕ:
>  
>  1. ЧТО **В НАСТРОЙКАХ ВАШИХ КЛИЕНТОВ**, КОТОРЫЕ ПОДКЛЮЧАЮТСЯ К НЕМУ ПО WIFI ИЛИ ПО VPN, 
>     В СТРОКЕ АДРЕСА ВАШЕГО DNS, УКАЗАН АДРЕС ВАШЕГО РОУТЕРА, А НЕ DNS ВАШЕГО ПРОВАЙДЕРА 
>     ИЛИ ИЗ СПИСКА СТАНДАРТНЫХ АДРЕСОВ ТИПА 8.8.8.8, 1.1.1.1, 9.9.9.9 ИЛИ ИМ ПОДОБНЫЕ. 
>  
>  2. ЧТО **ВАШ БРАУЗЕР НЕ ИСПОЛЬЗУЕТ СОБСТВЕННЫЕ DNS**, ТАК КАК ОНИ ИМЕЮТ БОЛЬШИЙ ПРИОРИТЕТ, 
>     ЧЕМ НАСТРОЙКИ, УКАЗАННЫЕ В ПУНКТЕ ВЫШЕ.
>    
>  3. ПРОВЕРЬТЕ, ЧТО **ОТКЛЮЧЕНА ПОДДЕРЖКА IPV6 В ЛИЧНОМ КАБИНЕТЕ ПРОВАЙДЕРА**, ЕСЛИ ТАКОВОЙ ПУНКТ ИМЕЕТСЯ. 
>     А ТАКЖЕ, ПРОВЕРЬТЕ, ЧТО **ДАННАЯ ОПЦИЯ (IP6) ОТКЛЮЧЕНА В СВОЙСТВАХ СЕТЕВОГО АДАПТЕРА ВАШЕГО КОМПЬЮТЕРА**.


# Установка пакета на устройство
#### После обязательной перезагрузки устройства:
1. Зайдите в entware своего роутера и введите команду `curl -sOfL https://raw.githubusercontent.com/qzeleza/kvas/main/ipk/update.sh && sh ./update.sh` и следуйте инструкциям на экране.

## ПРИМЕЧАНИЕ

> Если используется VPN-сервер IKEv2/IPsec, то в его настройках нужно изменить [служебный DNS 78.47.125.180](https://help.keenetic.com/hc/ru/articles/360017022999-VPN-сервер-IKEv2#:~:text=В%20качестве%20DNS-сервера%20по,все%20DNS-запросы%20на%20Keenetic) на IP-адрес роутера, например, на 192.168.1.1 (по умолчанию).

Если использовались домашние домены (добавленные командой ip host), то их можно добавить в конфиг `/opt/etc/hosts.dnsmasq`, например так:

$> **nano /opt/etc/hosts.dnsmasq**

address=/localdomain1.test/<IP_home_1>

address=/localdomain2.test/< IP_home_2>

и затем добавить имя `/opt/etc/hosts.dnsmasq` в файл `/opt/etc/dnsmasq.conf`:

$> **nano /opt/etc/dnsmasq.conf**

conf-file=/opt/etc/hosts.dnsmasq     # Добавляем эту строчку, если нужны локальные домены


# Удаление пакета
1. Частичное (сохраняя архивные копии) удаление пакета осуществляется командой `kvas remove`
1. Полное удаление пакета (вместе с зависимыми пакетами) осуществляется командой `kvas remove full`

   ![Снимок экрана 2022-12-17 в 12 40 54](https://user-images.githubusercontent.com/105032261/208236387-5e5bb99a-4f10-4beb-9e5a-588e7116c70f.png)


***Пример кода ПОЛНОГО удаления пакета:*** 
```sh
opkg remove kvas --autoremove # для ранних версий
kvas remove full. # или для поздних версий
```

# Диагностика в случае проблем
Существует два уровня диагностики:

1. Для проверки работы пакета наберите ```kvas test```
2. В случае отсутствия результата, наберите ```kvas debug > ./kvas.debug``` и отправьте сообщение автору через [форум Keenetic](https://forum.keenetic.com/profile/20603-zeleza/) или через его почту `kvas собачка zeleza.ru` сформированный **файл**.



# Использование AdGuard Home с пакетом Квас

## ВАЖНО!
> Квас не поддерживает **AdGuard Home** в случае, если **AdGuard Home** был установлен не через **entware** - командой `opkg Install`, а в ручную - путем копирования исполняемого файла c **GitHub**.

### Последовательность шагов:
1. После [установки Квас на устройство](#установка-пакета-на-устройство), устанавливаем **AdGuard Home** командой `kvas adguard on` и следуем инструкциям на экране.
   - После запроса, переходим в клиентский браузер по указанному **IP и номеру порта** и [осуществляем первичную настройку **AdGuardHome**](https://adguard.com/ru/blog/adguard-home-on-public-server.html).
   - В поле 'Веб-интерфейс администрирования' выберите IP своего роутера вышe
   - В поле 'DNS-сервер' выберите пункт 'Все интерфейсы' и на следующем шаге введите имя и дважды пароль для входа в интерфейс AdGuardHome
   - Далее, на следующей странице, нажмите на 'Открыть Панель Управления'.
   - После чего, установка AdGuard на роутере завершится автоматически.
2. Произойдет обновление и настройка **AdGuardHome** до крайней актуальной версии, после чего Вы можете проверить совместную работу Квас и **AdGuardHome** командой `kvas test` 


## ВАЖНО! 
> Пакет **AdGuard Home** должен быть установлен исключительно на роутер на котором установлен пакет **Квас**.
> Работа пакета **AdGuard Home** в связке с пакетом **Квас**, когда оба пакета находятся на различных устройствах **НЕ ПРЕДСТАВЛЯЕТСЯ ВОЗМОЖНОЙ**!

# Примеры использования
```sh
kvas setup         - запускаем первоначальную настройку пакета
kvas add ya.ru     - добавляем ya.ru в список разблокировки без поддержки регулярных выражений.
kvas add *ya.ru    - добавляем ya.ru в список разблокировки c поддержкой регулярных выражений.
kvas import ./list - добавляем хосты из файла в списочный файл.
kvas rm google     - удаляем все хосты со словом google внутри, из списка разблокировки.
kvas show          - выводим все хосты из списка разблокировки.
kvas test          - тестируем работу всех служб пакета.
kvas debug > ./log - сохраняем журнал отладочной информации в файл.
kvas purge         - удаляем все доменные имена из списка разблокировки.
kvas remove full   - производим ПОЛНОЕ удаление пакета со всеми архивными копиями.
```

## НАВИГАЦИЯ
- [**<<-- Описание пакета**](https://github.com/qzeleza/kvas/wiki/Home) 
- [**Описание команд -->>**](https://github.com/qzeleza/kvas/wiki/Описание-команд)