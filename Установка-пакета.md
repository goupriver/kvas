
# Подготовительные действия
1. **Подготовьте к работе свою учетную запись VPN** 

      - **Для Shadowsocks**

           1. Приобретите на стороне учетную запись **Shadowsocks** клиента, либо установите **[свой сервер на docker](https://github.com/shadowsocks/shadowsocks-libev/blob/master/docker/alpine/README.md)** (дело 5-ти минут).  
           2. Получите и приготовьте четыре параметра Вашего **Shadowsocks** сервера:
               - **IP адрес** или доменное имя сервера
               - **Номер** удаленного порта
               - **Пароль** для доступа
               - **Метод шифрования** на стороне сервера

      - Для других **VPN** соединений: **OpenVPN**, **Wireguard**, **IKE**, **PPPOE**, **L2TP**, **SSTP** - **[настройте подключение на своем роутере](https://help.keenetic.com/hc/ru/search?utf8=✓&query=Подключение+по+протоколу&commit=Поиск)** и проверьте его работоспособность. 
3. Установите систему пакетов репозитория **[Entware](https://help.keenetic.com/hc/ru/articles/360021214160)** на USB флешку на своем роутере.<br><br> _**Внимание!** систему пакетов Entware **НЕ РЕКОМЕНДУЕТСЯ** устанавливать [на встроенную память](https://help.keenetic.com/hc/ru/articles/360021888880) вашего роутера, в следствии того, что частые обращения к памяти быстро приводят к ее износу._
4. Этот шаг пропускаем, если у Вас установлена версия прошивки **начиная с версии 3.9.Х**. В случае же, если у Вас прошивка устройства **до версии 3.8.Х**, установите следующие необходимые компоненты в **WUI** роутера через меню 
**Общие настройки -> [Изменить набор компонентов](https://help.keenetic.com/hc/ru/articles/360009294539-Описание-компонентов-KeeneticOS)**:
    - **Модули ядра подсистемы Netfilter**
    - **Пакет расширения Xtables-addons для Netfilter**

   ![Снимок экрана 2022-12-17 в 12 52 55](https://user-images.githubusercontent.com/105032261/208236223-6c099545-336f-4cd5-8785-5c9bcf02aadf.png)
5. Убедитесь, что ваши клиенты используют "**Политику по умолчанию**" в разделе "**Интернет -> Приоритеты подключений -> Применение политик**" настроек роутера (**http://<IP роутера>/controlPanel/policies**)
![Снимок экрана 2023-11-27 в 04 16 32](https://github.com/qzeleza/kvas/assets/105032261/ca5fb4ec-ade0-4e5b-8daa-ac54de415c83)
6. Зайдите в админ панель роутера по адресу: **http://<IP роутера>/a** (будьте бдительны - символ **‘а’** в конце адреса не описка) и введите в поле **Command** следующую команду `opkg dns-override`, затем нажмите кнопку **Send request**.
   ![Снимок экрана 2022-12-17 в 12 37 52](https://user-images.githubusercontent.com/105032261/208235733-24d62843-8102-4905-bd16-69d461259862.png)
   ![Снимок экрана 2022-12-17 в 12 32 13](https://user-images.githubusercontent.com/105032261/208235772-278844ef-91be-4eda-af34-ce7f536c00f0.png)
7. Далее, необходимо сохранить настройки, в том же поле введите команду ```system configuration save```, затем нажмите кнопку **Send request**. 
8. И затем, **необходимо перегрузить роутер**, для этого, в том же поле введите ```system reboot```, после чего, нажмите **Send request**.

## ВНИМАНИЕ!
> После ввода команды `opkg dns-override` у Вас должен пропасть интернет. Это нормально. Так и должно быть.
> Все последующие шаги по установке пакета позволят его реанимировать.

## ВАЖНО!

>  ПЕРЕД ПОДКЛЮЧЕНИЕМ КЛИЕНТОВ К РОУТЕРУ ОБЯЗАТЕЛЬНО ПРОВЕРЬТЕ:
>  
>  1. ЧТО **В НАСТРОЙКАХ ВАШИХ КЛИЕНТОВ**, КОТОРЫЕ ПОДКЛЮЧАЮТСЯ К НЕМУ ПО WIFI ИЛИ ПО VPN, 
>     В СТРОКЕ АДРЕСА ВАШЕГО DNS, УКАЗАН АДРЕС ВАШЕГО РОУТЕРА, А НЕ DNS ВАШЕГО ПРОВАЙДЕРА 
>     ИЛИ ИЗ СПИСКА СТАНДАРТНЫХ АДРЕСОВ ТИПА 8.8.8.8, 1.1.1.1, 9.9.9.9 ИЛИ ИМ ПОДОБНЫЕ. 
>  
>  2. ЧТО **ВАШ БРАУЗЕР НЕ ИСПОЛЬЗУЕТ СОБСТВЕННЫЕ DNS**, ТАК КАК ОНИ ИМЕЮТ БОЛЬШИЙ ПРИОРИТЕТ, 
>     ЧЕМ НАСТРОЙКИ, УКАЗАННЫЕ В ПУНКТЕ ВЫШЕ.
>    
>  3. ПРОВЕРЬТЕ, ЧТО **ОТКЛЮЧЕНА ПОДДЕРЖКА IPV6 В ЛИЧНОМ КАБИНЕТЕ ПРОВАЙДЕРА**, ЕСЛИ ТАКОВОЙ ПУНКТ ИМЕЕТСЯ. 
>     А ТАКЖЕ, ПРОВЕРЬТЕ, ЧТО **ДАННАЯ ОПЦИЯ (IP6) ОТКЛЮЧЕНА В СВОЙСТВАХ СЕТЕВОГО АДАПТЕРА ВАШЕГО КОМПЬЮТЕРА**.


# Установка пакета на устройство
#### После обязательной перезагрузки устройства:
1. Зайдите в терминале по **ssh** в оболочку **entware** своего роутера.
2. Установите пакет **curl** командой `opkg install curl`
3. Выполните команду `curl -sOfL http://kvas.zeleza.ru/upgrade && sh upgrade` и далее, следуйте инструкциям на экране.

### ПРИМЕЧАНИЕ

Если использовались домашние доменные имена (добавленные командой ip host), то, при использовании сервера **dnsmasq**, их можно добавить в файл `/opt/etc/dnsmasq.d/hosts.dnsmasq`, например так:

> **nano /opt/etc/hosts.dnsmasq**
> address=/localdomain1.test/<IP_home_1><br>
> address=/localdomain2.test/< IP_home_2>

Далее, необходимо перезапустить сервис **dnsmasq** командой `/opt/etc/init.d/S56dnsmasq restart` или `kvas update`
Если используете **AdGuardHome**, то данные имена добавляйте вручную в разделе меню "**Фильтры -> Перезапись DNS запросов**"

# Обновление пакета на новую версию 

1. До версии **1.1.5-final-10**
> 1. Выполните команду на роутере `curl -sOLJ http://kvas.zeleza.ru/upgrade && sh upgrade` ([см. справку по командам](https://github.com/qzeleza/kvas/wiki/Описание-команд#настройка-и-удаление-пакета))
> 2. Далее, следуйте инструкциям на экране.

2. Начиная с версии **1.1.5-final-10** и выше 
> 1. Выполните команду на роутере `kvas upgrade` или `kvas upgrade full` ([см. справку по командам](https://github.com/qzeleza/kvas/wiki/Описание-команд#настройка-и-удаление-пакета))
> 2. Далее, следуйте инструкциям на экране.

3. Ручной вариант обновления
> 1. Сохраняем копию файла с хостами командой `kvas export /opt/etc/.kvas/kvas.list`
> 2. Удаляем предыдущую версию полностью `kvas rm full`  
> 3. Заходим на роутер и запускаем команду: `opkg Install https://github.com/qzeleza/kvas/releases/download/vX.X.X-xxxx/kvas_X.X.X-xxxx_all.ipk`, вместо иксов ставим версию необходимую. 
> 4. После установки запускаем `kvas setup` и следуем инструкциям на экране
> 5. Далее, восстанавливаем сохраненные хосты `kvas import /opt/etc/.kvas/kvas.list`
> 6. Тестируем Квас по желанию `kvas test`

# "Откат" пакета на более ранние версии 
> Возможно начиная с версии **1.1.7 release 6** 

`kvas rollback`       - без удаления данных предыдущей версии пакета<br>
`kvas rollback full`  - с удалением всех данных предыдущей версии пакета (установка по новой)

# Удаление пакета
1. Частичное (сохраняя архивные копии) удаление пакета осуществляется командой `kvas remove`
1. Полное удаление пакета (вместе с зависимыми пакетами) осуществляется командой `kvas remove full`

   ![Снимок экрана 2022-12-17 в 12 40 54](https://user-images.githubusercontent.com/105032261/208236387-5e5bb99a-4f10-4beb-9e5a-588e7116c70f.png)


***Пример кода ПОЛНОГО удаления пакета:*** 
```sh
opkg remove kvas --autoremove # ручное удаление пакета
kvas remove full              # автоматическое удаление пакета 
```


# Диагностика в случае проблем
Существует два уровня диагностики:

1. Для проверки работы пакета наберите ```kvas test```
2. В случае отсутствия результата, наберите ```kvas debug > ./kvas.debug``` и отправьте сообщение автору через [форум Keenetic](https://forum.keenetic.com/profile/20603-zeleza/) или через его почту `kvas собачка zeleza.ru` сформированный **файл**.

### ВНИМАНИЕ!
> При использовании **Shadowsocks** соединения, если Ваши клиенты подключаются без проблем, например, при подключении с сотового телефона, а на роутере **Квас** с этим подключеним перестает работать, то проверьте, несколько раз на верность, параметры **Shadowsocks** подключения.



# Использование AdGuard Home с пакетом Квас

## ВАЖНО!
> **Квас** **НЕ** поддерживает **AdGuardHome** в случае, если **AdGuardHome** был установлен не через **entware** - командой `opkg Install`, а в ручную - путем копирования исполняемого файла c **GitHub**.

> **Квас** поддерживает работу с **AdGuardHome**, **ТОЛЬКО** на том устройстве, на котором установлен **КВАС**. При установке **AdGuardHome** надругое устройство **данная связка работать не будет**.

### Последовательность шагов:
1. После [установки Квас на устройство](#установка-пакета-на-устройство), устанавливаем **AdGuard Home** командой `kvas adguard on` и следуем инструкциям на экране.
   1.  После запроса, переходим в клиентский браузер по указанному **IP и номеру порта** и [осуществляем первичную настройку **AdGuardHome**](https://adguard.com/ru/blog/adguard-home-on-public-server.html).
   2.  В поле **Веб-интерфейс администрирования** выберите **IP своего роутера** вышe и затем любой порт, на котором Вы хотите управлять сервисом **AdGuardHome**.
   3.  **ВАЖНО** В поле **DNS-сервер** выберите пункт **Все интерфейсы** 
   4.  На следующем шаге введите имя и дважды пароль для входа в интерфейс **AdGuardHome**
   5.  Далее, на следующей странице, нажмите на **Открыть Панель Управления**.
   6.  После чего, установка **AdGuardHome** на роутере завершится автоматически.
2. Произойдет обновление и настройка **AdGuardHome** до крайней актуальной версии, после чего Вы можете проверить совместную работу Квас и **AdGuardHome** командой `kvas test` 


## ВАЖНО! 
> Пакет **AdGuard Home** должен быть установлен исключительно на роутер на котором установлен пакет **Квас**.
> Работа пакета **AdGuard Home** в связке с пакетом **Квас**, когда оба пакета находятся на различных устройствах **НЕ ПРЕДСТАВЛЯЕТСЯ ВОЗМОЖНОЙ**!

# Примеры использования
```sh
kvas setup         - запускаем первоначальную настройку пакета
kvas add ya.ru     - добавляем ya.ru в список разблокировки. Для поддержкой регулярных выражений введите, при запросе - 'Y'.
kvas import ./list - добавляем хосты из файла в списочный файл.
kvas rm google     - удаляем все хосты со словом google внутри, из списка разблокировки.
kvas show          - выводим все хосты из списка разблокировки.
kvas test          - тестируем работу всех служб пакета.
kvas debug > ./log - сохраняем журнал отладочной информации в файл.
kvas purge         - удаляем все доменные имена из списка разблокировки.
kvas remove full   - производим ПОЛНОЕ удаление пакета со всеми архивными копиями.
```

## НАВИГАЦИЯ
- [**<<-- Описание пакета**](https://github.com/qzeleza/kvas/wiki/Home) 
- [**Описание команд -->>**](https://github.com/qzeleza/kvas/wiki/Описание-команд)