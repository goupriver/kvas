# Диагностика проблем

## Общая диагностика

Для решения возникающих проблем пробуем запустить тесты, которые в случае проблемы укажут на ее корень
`kvas test` и `kvas debug` 

Различия между ними в том, что `kvas test` позволяет с клиента взглянуть на то, работает ли Квас или нет. 
Команда же `kvas debug` предназначена для простой проверки состояния всех элементов Кваса и в большей степени предназначена для разработчика и продвинутых пользователей.

Для отправки диагностики в адрес разработчика необходимо выполнить следующую команду `kvas debug имя_файла`, где имя_файла - это полный путь до файла диагностики. При выполнении данной команды, которая отлична от простого вывода в файл типа `kvas debug > имя_файла`, очищаются командные символы цвета текста, потому, при отправке отчета, лучше всего использовать встроенную команду `kvas debug имя_файла`.

## Проверка работы гостевых сетей и их клиентов. Автор методики теста [ALTernateF13](https://github.com/ALTernateF13)

1. Сохраняем правила **iptables** командой `iptables-save | grep -E 'PREROUTING|nat' | grep -vE '_NDM|^\*|^\:' &> /opt/tmp/kvas_iptables_step_1.txt`. 

2. Для просмотра текущих ошибок в самом роутере, открываем веб-интерфейс роутера (WUI) и переходим в лог роутера в раздел **«Диагностика» -> «Показать журнал»**. В случае необходимости, используем кнопку «**Очистить журнал**».

3. Отключаем обход всех гостевых сетей командой `kvas vpn net del`, выбирая каждую из списка, пока список не будет пустым. 

4. Далее, обновляем **Квас** командой **kvas upgrade full** и сохраняем лог-файл для **iptables** командой командой `iptables-save | grep -E 'PREROUTING|nat' | grep -vE '_NDM|^\*|^\:' &> /opt/tmp/kvas_iptables_step_2.txt`, после чего проверяем работает ли Квас на основной сети. Смотрим лог роутера на отсутствие ошибок; скриним, если есть. Сохраняем лог-файл **kvas debug /opt/tmp/kvas_debug.txt**.

5. Настраиваем проверяемую гостевую сеть в админке роутера, в случае с **IKEv2**, **DNS** должен быть равен **IP** роутера, чаще всего это **192.168.1.1**. Далее, включаем обход **КВАСа** для гостевой сети командой `kvas vpn net add` и сохраняем лог-файл для **iptables** командой `iptables-save | grep -E 'PREROUTING|nat' | grep -vE '_NDM|^\*|^\:' &> /opt/tmp/kvas_iptables_step_3.txt`, после чего, проверяем работу клиентов гостевой сети - идет ли трафик с них через **Квас**? Смотрим лог роутера на отсутствие ошибок, а в случае **IKEv2** ещё, что отсутствуют перезапуски сетевых интерфейсов. Все ошибки в логе роутера "скриним" в файл для последующей отправки разработчику.

6. Меняем одну любую несущественную настройку гостевой в админке роутера. Сохраняем лог-файл для iptables командой `iptables-save | grep -E 'PREROUTING|nat' | grep -vE '_NDM|^\*|^\:' &> /opt/tmp/kvas_iptables_step_4.txt` и проверяем восстановление правил обхода гостевой. Смотрим лог роутера на отсутствие ошибок и на факт перезапуска соответствующего гостевого сетевого интерфейса. Все ошибки в логе роутера "скриним" в файл для последующей отправки разработчику.

7. Отключаем обход гостевых `kvas vpn net del`. Сохраняем лог-файл для **iptables** командой `iptables-save | grep -E 'PREROUTING|nat' | grep -vE '_NDM|^\*|^\:' &> /opt/tmp/kvas_iptables_step_5.txt`, проверяем, что правила обхода гостевой сети удалены. се ошибки в логе роутера "скриним" в файл для последующей отправки разработчику.

8. В случае, если проверяемая гостевую сеть у нас типа **IKEv2**, то , для проверки его работы, в админ панели роутера устанавливаем **DNS** сервер по умолчанию значение **78.47.125.180** и включаем обход гостевой сети для **IKEv2** командой **kvas vpn net add**. После чего сохраняем лог-файл для **iptables** командой `iptables-save | grep -E 'PREROUTING|nat' | grep -vE '_NDM|^\*|^\:' &> /opt/tmp/kvas_iptables_step_6.txt` и проверяем наличие новых правил обхода гостевой сети. Смотрим лог роутера на отсутствие ошибок и на факт перезапуска соответствующего гостевого сетевого интерфейса. Все ошибки в логе роутера "скриним" в файл для последующей отправки разработчику.

9. Перезагружаем роутер. Сохраняем лог-файл для **iptables**  командой `iptables-save | grep -E 'PREROUTING|nat' | grep -vE '_NDM|^\*|^\:' &> /opt/tmp/kvas_iptables_step_7.txt` и проверяем восстановление правил обхода гостевой сети.
